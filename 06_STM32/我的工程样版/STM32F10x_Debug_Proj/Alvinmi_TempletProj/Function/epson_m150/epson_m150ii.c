#include <stdio.h>
#include "epson_m150ii.h"
#include "sys.h"
#include "string.h"
#include "delay.h"

PRINTER_CTR_TYPE p_ctr;			// 打印点行的结构体
uint8_t byPrinter_head_ITFlag;	// 中断处理标志位

// ----------------- 变量 ------------------- //
uint8_t g_bTimingIntr;	
uint8_t g_bResetIntr;		

const u8 dot_a[] = {1,5, 9,13,17,21,25,29,33,37,41,45,49,53,57,61,65,69,73,77,81,85,89,93,97};
const u8 dot_b[] = {2,6,10,14,18,22,26,30,34,38,42,46,50,54,58,62,66,70,74,78,82,86,90,94,98};
const u8 dot_c[] = {3,7,11,15,19,23,27,31,35,39,43,47,51,55,59,63,67,71,75,79,83,87,91,95,99};
const u8 dot_d[] = {4,8,12,16,20,24,28,32,36,40,44,48,52,56,60,64,68,72,76,80,84,88,92,96,100};

u8 a_i = 0;		// 记录 Head_a 所在位置的变量 
u8 b_i = 0;		// 记录 Head_b 所在位置的变量 
u8 c_i = 0;		// 记录 Head_c 所在位置的变量 
u8 d_i = 0;		// 记录 Head_d 所在位置的变量 

u8 print_real[7][12];		// 最终需要打印缓存的 buffer.
u8 ascii_printer[12][7];	// 需要打印矩阵倒置前的 buffer.
u8 finishi_flag = 0;	// 打印完12 行停电机

// 横向取模
// 这是一个 5x7 的 ASCII 码字库的数组。一共有 96 个可打印的 ASCII码。
unsigned char const ascii_5x7[96][7]={
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,//' ' 	0
	0x04,0x04,0x04,0x04,0x04,0x00,0x04,//'!' 	1
	0x05,0x05,0x05,0x00,0x00,0x00,0x00,//'"' 	2
	0x0A,0x0A,0x1F,0x0A,0x1F,0x0A,0x0A,//'#' 	3
	0x11,0x0A,0x1F,0x04,0x1F,0x04,0x04,//'￥' 	4   将 '￥' 替换成 '$'
//	0x04,0x1E,0x05,0x0E,0x14,0x0F,0x04,//'$' 	4
	0x03,0x13,0x08,0x04,0x02,0x19,0x18,//'%' 	5
	0x06,0x09,0x05,0x02,0x15,0x09,0x16,//'&' 	6
	0x03,0x02,0x01,0x00,0x00,0x00,0x00,//''' 	7
	0x04,0x02,0x01,0x01,0x01,0x02,0x04,//'(' 	8
	0x01,0x02,0x04,0x04,0x04,0x02,0x01,//')' 	9
	0x00,0x0A,0x04,0x1F,0x04,0x0A,0x00,//'*' 	10
	0x00,0x04,0x04,0x1F,0x04,0x04,0x00,//'+' 	11
	0x00,0x00,0x00,0x00,0x03,0x02,0x01,//',' 	12
	0x00,0x00,0x00,0x1F,0x00,0x00,0x00,//'-' 	13
	0x00,0x00,0x00,0x00,0x00,0x03,0x03,//'.' 	14
	0x00,0x10,0x08,0x04,0x02,0x01,0x00,//'/' 	15
	0x0E,0x11,0x19,0x15,0x13,0x11,0x0E,//'0' 	16
	0x04,0x06,0x04,0x04,0x04,0x04,0x0E,//'1' 	17
	0x0E,0x11,0x10,0x0C,0x02,0x01,0x1F,//'2' 	18
	0x0E,0x11,0x10,0x0C,0x10,0x11,0x0E,//'3' 	19
	0x08,0x0C,0x0A,0x09,0x1F,0x08,0x08,//'4' 	20
	0x1F,0x01,0x0F,0x10,0x10,0x11,0x0E,//'5' 	21
	0x0C,0x02,0x01,0x0F,0x11,0x11,0x0E,//'6' 	22
	0x1F,0x10,0x08,0x04,0x02,0x02,0x02,//'7' 	23
	0x0E,0x11,0x11,0x0E,0x11,0x11,0x0E,//'8' 	24
	0x0E,0x11,0x11,0x1E,0x10,0x08,0x06,//'9' 	25
	0x00,0x03,0x03,0x00,0x03,0x03,0x00,//':' 	26
	0x00,0x03,0x03,0x00,0x03,0x02,0x01,//';' 	27
	0x08,0x04,0x02,0x01,0x02,0x04,0x08,//'<' 	28
	0x00,0x00,0x1F,0x00,0x1F,0x00,0x00,//'=' 	29
	0x01,0x02,0x04,0x08,0x04,0x02,0x01,//'>' 	30
	0x0E,0x11,0x10,0x08,0x04,0x00,0x04,//'?' 	31
	0x0E,0x11,0x10,0x16,0x15,0x15,0x0E,//'@' 	32
	0x0E,0x11,0x11,0x1F,0x11,0x11,0x11,//'A' 	33
	0x0F,0x11,0x11,0x0F,0x11,0x11,0x0F,//'B' 	34
	0x0E,0x11,0x01,0x01,0x01,0x11,0x0E,//'C' 	35
	0x07,0x09,0x11,0x11,0x11,0x09,0x07,//'D' 	36
	0x1F,0x01,0x01,0x0F,0x01,0x01,0x1F,//'E' 	37
	0x1F,0x01,0x01,0x0F,0x01,0x01,0x01,//'F' 	38
	0x0E,0x11,0x01,0x01,0x19,0x11,0x1E,//'G' 	39
	0x11,0x11,0x11,0x1F,0x11,0x11,0x11,//'H' 	40
	0x07,0x02,0x02,0x02,0x02,0x02,0x07,//'I' 	41
	0x1C,0x08,0x08,0x08,0x08,0x09,0x06,//'J' 	42
	0x11,0x09,0x05,0x03,0x05,0x09,0x11,//'K' 	43
	0x01,0x01,0x01,0x01,0x01,0x01,0x1F,//'L' 	44
	0x11,0x1B,0x15,0x15,0x11,0x11,0x11,//'M' 	45
	0x11,0x11,0x13,0x15,0x19,0x11,0x11,//'N' 	46
	0x0E,0x11,0x11,0x11,0x11,0x11,0x0E,//'O' 	47
	0x0F,0x11,0x11,0x0F,0x01,0x01,0x01,//'P' 	48
	0x0E,0x11,0x11,0x11,0x15,0x09,0x16,//'Q' 	49
	0x0F,0x11,0x11,0x0F,0x05,0x09,0x11,//'R' 	50
	0x0E,0x11,0x01,0x0E,0x10,0x11,0x0E,//'S' 	51
	0x1F,0x04,0x04,0x04,0x04,0x04,0x04,//'T' 	52
	0x11,0x11,0x11,0x11,0x11,0x11,0x0E,//'U' 	53
	0x11,0x11,0x11,0x11,0x11,0x0A,0x04,//'V' 	54
	0x11,0x11,0x11,0x15,0x15,0x15,0x0A,//'W' 	55
	0x11,0x11,0x0A,0x04,0x0A,0x11,0x11,//'X' 	56
	0x11,0x11,0x0A,0x04,0x04,0x04,0x04,//'Y' 	57
	0x1F,0x10,0x08,0x04,0x02,0x01,0x1F,//'Z' 	58
	0x07,0x01,0x01,0x01,0x01,0x01,0x07,//'[' 	59
	0x00,0x01,0x02,0x04,0x08,0x10,0x00,//'\' 	60
	0x07,0x04,0x04,0x04,0x04,0x04,0x07,//']' 	61
	0x04,0x0A,0x11,0x00,0x00,0x00,0x00,//'^' 	62
	0x00,0x00,0x00,0x00,0x00,0x00,0x1F,//'_' 	63
	0x01,0x02,0x04,0x00,0x00,0x00,0x00,//'`' 	64
	0x00,0x00,0x0E,0x10,0x1E,0x11,0x1E,//'a' 	65
	0x01,0x01,0x0D,0x13,0x11,0x11,0x0F,//'b' 	66
	0x00,0x00,0x06,0x09,0x01,0x09,0x06,//'c' 	67
	0x10,0x10,0x16,0x19,0x11,0x11,0x1E,//'d' 	68
	0x00,0x00,0x0E,0x11,0x1F,0x01,0x0E,//'e' 	69
	0x04,0x0A,0x02,0x07,0x02,0x02,0x02,//'f' 	70
	0x00,0x1E,0x11,0x11,0x1E,0x10,0x0E,//'g' 	71
	0x01,0x01,0x0D,0x13,0x11,0x11,0x11,//'h' 	72
	0x01,0x00,0x01,0x01,0x01,0x01,0x01,//'i' 	73
	0x04,0x00,0x06,0x04,0x04,0x04,0x03,//'j' 	74
	0x01,0x01,0x09,0x05,0x03,0x05,0x09,//'k' 	75
	0x03,0x02,0x02,0x02,0x02,0x02,0x07,//'l' 	76
	0x00,0x00,0x0B,0x15,0x11,0x11,0x11,//'m' 	77
	0x00,0x00,0x0D,0x0B,0x09,0x09,0x09,//'n' 	78
	0x00,0x00,0x06,0x09,0x09,0x09,0x06,//'o' 	79
	0x00,0x07,0x09,0x09,0x07,0x01,0x01,//'p' 	80
	0x00,0x0E,0x09,0x09,0x0E,0x08,0x08,//'q' 	81
	0x00,0x00,0x05,0x03,0x01,0x01,0x01,//'r' 	82
	0x00,0x00,0x0E,0x01,0x06,0x08,0x07,//'s' 	83
	0x02,0x02,0x07,0x02,0x02,0x02,0x02,//'t' 	84
	0x00,0x00,0x09,0x09,0x09,0x09,0x0E,//'u' 	85
	0x00,0x00,0x11,0x11,0x11,0x0A,0x04,//'v' 	86
	0x00,0x00,0x11,0x11,0x15,0x15,0x0A,//'w' 	87
	0x00,0x00,0x11,0x0A,0x04,0x0A,0x11,//'x' 	88
	0x00,0x09,0x09,0x09,0x0E,0x08,0x06,//'y' 	89
	0x00,0x00,0x1F,0x08,0x04,0x02,0x1F,//'z' 	90
	0x04,0x02,0x02,0x01,0x02,0x02,0x04,//'{' 	91
	0x02,0x02,0x02,0x02,0x02,0x02,0x02,//'|' 	92
	0x01,0x02,0x02,0x04,0x02,0x02,0x01,//'}' 	93
	0x16,0x09,0x00,0x00,0x00,0x00,0x00,//'~' 	94
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,//'?' 	95
};

u8 ascii_test[12][7]={
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
/*
	0x55,0xAA,0x55,0xAA,0x55,0xAA,0x55,
	0x55,0xAA,0x55,0xAA,0x55,0xAA,0x55,
	0x55,0xAA,0x55,0xAA,0x55,0xAA,0x55,
	0x55,0xAA,0x55,0xAA,0x55,0xAA,0x55,
	0x55,0xAA,0x55,0xAA,0x55,0xAA,0x55,
	0x55,0xAA,0x55,0xAA,0x55,0xAA,0x55,
	0x55,0xAA,0x55,0xAA,0x55,0xAA,0x55,
	0x55,0xAA,0x55,0xAA,0x55,0xAA,0x55,
	0x55,0xAA,0x55,0xAA,0x55,0xAA,0x55,
	0x55,0xAA,0x55,0xAA,0x55,0xAA,0x55,
	0x55,0xAA,0x55,0xAA,0x55,0xAA,0x55,
	0x55,0xAA,0x55,0xAA,0x55,0xAA,0x55,
*/
};	

// Printer IO Init
void Printer_IO_Config(void)
{
	GPIO_InitTypeDef    GPIO_InitStructure;
	EXTI_InitTypeDef 	EXTI_InitStructure;	
	NVIC_InitTypeDef NVIC_InitStructure;
	
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_AFIO | RCC_APB2Periph_GPIOB | RCC_APB2Periph_GPIOC , ENABLE);
	
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_2MHz;	// A 
	GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_Out_PP;
	GPIO_InitStructure.GPIO_Pin	  = PTA_PIN;
	GPIO_Init(PTA_PORT, &GPIO_InitStructure);	

	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_2MHz;	// B 
	GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_Out_PP;
	GPIO_InitStructure.GPIO_Pin   = PTB_PIN;
	GPIO_Init(PTB_PORT, &GPIO_InitStructure);	

	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_2MHz;	// C 
	GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_Out_PP;
	GPIO_InitStructure.GPIO_Pin   = PTC_PIN;
	GPIO_Init(PTC_PORT, &GPIO_InitStructure);	

	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_2MHz;	// D 
	GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_Out_PP;
	GPIO_InitStructure.GPIO_Pin   = PTD_PIN;
	GPIO_Init(PTD_PORT, &GPIO_InitStructure);	
	
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_2MHz;	// 配置 LED1(PB14) 引脚 (不是必须)
	GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_Out_PP;
	GPIO_InitStructure.GPIO_Pin   = GPIO_Pin_14;
	GPIO_Init(GPIOB, &GPIO_InitStructure);
	GPIO_SetBits(GPIOB, GPIO_Pin_14);	// 关闭

	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_2MHz;	// 配置 LED2(PB15) 引脚 (不是必须)
	GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_Out_PP;
	GPIO_InitStructure.GPIO_Pin   = GPIO_Pin_15;
	GPIO_Init(GPIOB, &GPIO_InitStructure);
	GPIO_SetBits(GPIOB, GPIO_Pin_15);	// 关闭

	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;			// Motor
	GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_Out_PP;
	GPIO_InitStructure.GPIO_Pin   = MOTER_PIN;
	GPIO_Init(MOTER_PORT, &GPIO_InitStructure);	
	
	/******************  TIMGIMG 外部中断 ******************/
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;			// Timing 
	GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_IN_FLOATING;
	GPIO_InitStructure.GPIO_Pin   = PT_TIMER_PIN;
	GPIO_Init(PT_TIMER_PORT, &GPIO_InitStructure);	

	EXTI_InitStructure.EXTI_Mode 	= EXTI_Mode_Interrupt;
	EXTI_InitStructure.EXTI_Line 	= EXTI_Line9;
	EXTI_InitStructure.EXTI_Trigger = EXTI_Trigger_Rising_Falling;		// EXTI_Trigger_Rising_Falling
	EXTI_InitStructure.EXTI_LineCmd = ENABLE;
	EXTI_Init(&EXTI_InitStructure);		
	GPIO_EXTILineConfig(GPIO_PortSourceGPIOB, GPIO_PinSource9);
	EXTI_ClearITPendingBit(EXTI_Line9);		// Clean Timing IT Flag

	/******************  Reset Signal 外部中断 ******************/
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_IPU;
	GPIO_InitStructure.GPIO_Pin	  = PT_RESET_DETCT_PIN;
	GPIO_Init(PT_RESET_DETCT_PORT, &GPIO_InitStructure);	
	
	EXTI_InitStructure.EXTI_Mode 	= EXTI_Mode_Interrupt;
	EXTI_InitStructure.EXTI_Line 	= EXTI_Line8;
 	EXTI_InitStructure.EXTI_Trigger = EXTI_Trigger_Falling;		// 下降沿触发	
 	EXTI_InitStructure.EXTI_LineCmd = ENABLE;
	EXTI_Init(&EXTI_InitStructure);
	GPIO_EXTILineConfig(GPIO_PortSourceGPIOB, GPIO_PinSource8);
	EXTI_ClearITPendingBit(EXTI_Line8);		// Clean Timing IT Flag
	
	// Reset	PB10 
	NVIC_InitStructure.NVIC_IRQChannel = EXTI9_5_IRQn;	
	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 4;
	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 1;
	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
	NVIC_Init(&NVIC_InitStructure);
}

// 打印前初始化
void Printer_Timer_Init(void)
{
	p_ctr.r_h = 0;
	p_ctr.t_h = 0;
	p_ctr.t_num = 0;
}

// 提取相关的数据
/**************************************************
* 函数: void Printer_Font_Extract(char *String)
* 功能: 字符串打印输入
* 参数: String  字符串长度不能大于 12
* 返回值: Null
**************************************************/
void Printer_Font_Extract(char *String,char len)
{
	u8 line_null;
	u8 i,j;
	u8 StringLen = 0x00;
	int x, y;
//	StringLen = strlen(String);
	StringLen = len;	// 打印机字符串的长度.

	// 从字库中取数据填到 buffer 中
	line_null = 12 - StringLen;
	
	for(j = 0; j < StringLen; j++)
	{
		for(i = 0; i < 7; i++)
		{
			ascii_printer[j + line_null][i] = ascii_5x7[*String - 0x20][i];
		}
		String++;
	}	
	
	// 打印点阵 buffer 倒置
	for(x = 0;x < 7; x++)
	{
		for(y = 0;y < 12; y++)
		{
			print_real[x][y] = ascii_printer[y][x];
//			print_real[x][y] = ascii_test[y][x];		// test print ascii 
		}
	}
}

// Print line dot. 
void Printer_line(void)
{
	u8 space_line = 5;
	
	if(g_bTimingIntr)
	{
		PTA_OFF();
		PTB_OFF();
		PTC_OFF();
		PTD_OFF();
	
		g_bTimingIntr = 0;	// Timing clean.
		p_ctr.t_num ++;
	}
	
	if(g_bResetIntr)	// if receive Reset signal, print line finish, line_number++ 
	{
		g_bResetIntr = 0;	// Reset clean.
		p_ctr.line_num ++;	// printer line finish.

		p_ctr.t_num = 0;		// 记录打印的点清零
		p_ctr.t_num_back = 0; 

		a_i = 0;
		b_i = 0;
		c_i = 0;
		d_i = 0;
	}
	
	if(d_i > 23)	// 打印到最后一个点的时候, 清除针头点的记录
	{
		a_i = 0;
		b_i = 0;
		c_i = 0;
		d_i = 0;
	}
	
	if(p_ctr.line_num > 7 + space_line)	// 打印完成一个点行.	
	{
		MOTER_OFF();
		p_ctr.line_num = 0;
		p_ctr.t_num = 0;
		p_ctr.t_num_back = 0;
		p_ctr.p_on = 0;
		PTA_OFF();
		PTB_OFF();
		PTC_OFF();
		PTD_OFF();
	}
	
	// Judge printer head work logic
	if((p_ctr.t_num < 97) && (p_ctr.t_num != p_ctr.t_num_back) && (p_ctr.line_num > space_line))
	{
		p_ctr.t_num_back = p_ctr.t_num;
		
		/* A */
		if(p_ctr.t_num == dot_a[a_i])
		{
//			if((print_real[p_ctr.line_num-1-space_line][a_i >> 3] & (0x01 << (a_i & 0x07))))
			if((print_real[p_ctr.line_num-1-space_line][a_i/6] & (0x01 << (a_i%6))))
			{
				PTA_ON();
			}else
			{
				PTA_OFF();
			}
			a_i++;
		}

		/* B */
		if(p_ctr.t_num == dot_b[b_i])
		{
//			if((print_real[p_ctr.line_num-1-space_line][(b_i >> 3) + 3] & (0x01 << (b_i & 0x07))))
			if((print_real[p_ctr.line_num-1-space_line][(b_i/6) + 4] & (0x01 << (b_i%6))))
			{
				PTB_ON();
			}else
			{
				PTB_OFF();
			}
			b_i++;
		}

		/* C */
		if(p_ctr.t_num == dot_c[c_i])
		{
//			if((print_real[p_ctr.line_num-1-space_line][(c_i >> 3) + 6] & (0x01 << (c_i & 0x07))))
			if((print_real[p_ctr.line_num-1-space_line][(c_i/6) + 8] & (0x01 << (c_i%6))))
			{
				PTC_ON();
			}else
			{
				PTC_OFF();
			}
			c_i++;
		}

		/* D */
		if(p_ctr.t_num == dot_d[d_i])
		{
//			if((print_real[p_ctr.line_num-1-space_line][(d_i >> 3) + 9] & (0x01 << (d_i & 0x07))))
			if((print_real[p_ctr.line_num-1-space_line][(d_i/6) + 12] & (0x01 << (d_i%6))))
			{
				PTD_ON();
			}else
			{
				PTD_OFF();
			}
			d_i++;
		}
	}
}

// Epson 打印机初始化
void Epson_Printer_Init(void)
{
	Printer_IO_Config();	// 打印机 IO 初始化
	Printer_Timer_Init();   // 打印前初始化变量
}

/*******************************************************************************
* Function Name  : void Print_Invoice(char *str,char len)
* Description    : 发票打印接口
* Input          : char *str: 打印传递的字符串.  char len: 字符串的长度
* Output         : 
* Return         : none
*******************************************************************************/
void Print_Invoice(char *str,char len)
{
	Printer_Font_Extract(str,len);
	while(MOTER_STA==1);		// 等待打印机打印完成, 就不用一直在 while 中查询
	memset(ascii_printer, 0x00, sizeof(ascii_printer));
	memset(print_real, 0x00, sizeof(print_real));
}

